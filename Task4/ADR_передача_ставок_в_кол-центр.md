---
up:
  - "[[Task4]]"
---
# ADR: Передача ставок в кол-центр и партнерский кол-центр

**Автор:** Архитектор цифровой трансформации
**Дата:** 02.10.2025
**Статус:** Утверждено
**Версия:** 2.0
**Связано с:** Task 3 - ADR Открытие депозитов онлайн

## Задача

Обеспечить доступ сотрудников кол-центра и партнерского кол-центра к актуальным ставкам по депозитам для консультирования клиентов банка "Стандарт" в период запуска MVP депозитов онлайн. Решение должно интегрироваться с архитектурой MVP, разработанной в Task 3.

## Функциональные требования (Use Cases)

| ID | Use Case | Описание | Актор |
|----|----------|----------|-------|
| UC1 | Консультация по ставкам в кол-центре | Сотрудник кол-центра консультирует клиента по актуальным депозитным ставкам через систему кол-центра | Сотрудник кол-центра |
| UC2 | Обновление ставок в системе кол-центра | Система автоматически получает актуальные ставки из сервиса управления ставками | Система кол-центра |
| UC3 | Получение файла ставок партнерским кол-центром | Партнерский кол-центр получает файл с актуальными ставками через SFTP | Партнерский кол-центр |
| UC4 | Консультация в партнерском кол-центре | Сотрудник партнерского кол-центра консультирует клиента по ставкам из полученного файла | Сотрудник партнерского кол-центра |
| UC5 | Генерация файла ставок | Система автоматически генерирует файл со ставками для партнерского кол-центра | Сервис управления ставками |
| UC6 | Мониторинг передачи ставок | Администратор отслеживает успешность передачи ставок в оба кол-центра | Администратор системы |

## Нефункциональные требования

### Производительность
- **Обновление ставок в кол-центре:** < 15 минут после изменения для своевременных консультаций
- **Генерация файла для партнеров:** < 30 минут (соответствие SLA с партнером)
- **Время отклика Rate API:** < 500 мс для запросов кол-центра
- **Кеширование:** TTL 5 минут для снижения нагрузки на БД

### Надежность
- **Доступность сервиса:** 99.9% (критичность для консультаций)
- **Резервирование каналов:** дублирование SFTP соединений
- **Retry механизм:** автоматические повторы при сбоях передачи файлов
- **Мониторинг:** отслеживание всех интеграций в реальном времени

### Безопасность
- **Шифрование файлов:** AES-256 для партнерского кол-центра
- **SFTP аутентификация:** ключи SSH для контроля доступа
- **API аутентификация:** OAuth 2.0 токены для кол-центра
- **Аудит:** логирование всех запросов и передач файлов

### Совместимость
- **API:** REST/JSON для минимизации доработок системы кол-центра
- **Формат файлов:** CSV/Excel согласно требованиям партнера (+R7 из Task2)
- **Технологии:** .NET Core, MS SQL (S1, S2 из Task2)

### Масштабируемость
- **Горизонтальное масштабирование:** Rate API и File Generator
- **Поддержка множества партнеров:** расширяемая архитектура SFTP
- **Rate limiting:** ограничение запросов для защиты сервиса

## Решение

### Концептуальная архитектура

Решение расширяет архитектуру MVP депозитов онлайн (из Task 3) добавлением компонентов для передачи ставок в кол-центры. Основа - централизованный сервис управления ставками с дополнительными интеграциями.

### Ключевые архитектурные решения:

1. **Расширение Сервиса управления ставками** - добавление API для кол-центра и модуля генерации файлов
2. **API интеграция с кол-центром** - REST API для получения актуальных ставок
3. **SFTP сервер** - для передачи файлов партнерскому кол-центру
4. **Планировщик задач** - автоматическая генерация и передача файлов

### Основные компоненты (расширение архитектуры из Task 3):

#### 1. Rate API (расширение существующего компонента)
**Технологии:** .NET Core REST API, Redis Cache
**Ответственность:**
- REST API для кол-центра банка (новое)
- Кеширование ставок (TTL 5 мин) для быстрого доступа
- OAuth 2.0 аутентификация для внешних систем
- Rate limiting для защиты от перегрузки
- Мониторинг запросов и производительности

#### 2. File Generator (новый компонент)
**Технологии:** .NET Core Background Service, Hangfire
**Ответственность:**
- Генерация CSV/Excel файлов со ставками по расписанию
- Шифрование файлов (AES-256) для партнеров
- Версионирование и проверка целостности файлов
- Архивирование старых файлов
- Интеграция с SFTP сервером

#### 3. Scheduler (новый компонент)
**Технологии:** Hangfire, .NET Core
**Ответственность:**
- Автоматическая генерация файлов каждые 30 минут
- Retry механизм при сбоях
- Мониторинг выполнения задач
- Настраиваемое расписание для разных партнеров

#### 4. SFTP Server (новая инфраструктура)
**Технологии:** OpenSSH
**Ответственность:**
- Безопасная передача файлов партнерскому кол-центру
- SSH ключи для аутентификации
- Логирование всех операций передачи
- Мониторинг статуса доставки и retry
- Изоляция доступа партнеров (chroot окружение)

#### 5. Redis Cache (новая инфраструктура)
**Технологии:** Redis
**Ответственность:**
- Кеширование ставок для Rate API
- Снижение нагрузки на Rate DB
- TTL 5 минут для актуальности данных
- Поддержка горизонтального масштабирования

#### 6. Система кол-центра (доработка существующей)
**Технологии:** Proprietary CRM, REST Client
**Ответственность:**
- Integration Module для получения ставок из Rate API
- Отображение актуальных ставок операторам
- Кеширование на стороне клиента

### Интеграции и потоки данных:

#### Поток 1: Обновление ставок кол-центром банка
1. **Система кол-центра (Integration Module) → Rate API** (REST/JSON) - запрос актуальных ставок
2. **Rate API → Redis Cache** (проверка кеша) - если данные актуальны, возврат из кеша
3. **Rate API → Rate DB** (ADO.NET) - если кеш устарел, чтение из БД
4. **Rate API → Redis Cache** (обновление кеша с TTL 5 мин)
5. **Rate API → Система кол-центра** (REST/JSON) - возврат ставок
6. **Integration Module → CRM Application** - отображение ставок оператору

**Характеристики:**
- Время отклика: < 500 мс
- Аутентификация: OAuth 2.0 токены
- Rate limiting: max 100 запросов/мин на клиента

#### Поток 2: Генерация файлов для партнерского кол-центра
1. **Scheduler** (каждые 30 минут) - запуск задачи генерации
2. **Scheduler → File Generator** (Hangfire) - триггер генерации
3. **File Generator → Rate DB** (ADO.NET) - чтение актуальных ставок
4. **File Generator** - генерация CSV/Excel файла
5. **File Generator** - шифрование файла (AES-256)
6. **File Generator → File Storage** (File I/O) - сохранение файла с timestamp
7. **File Storage → SFTP Server** (SFTP Protocol) - размещение файла в директории партнера
8. **Партнерский кол-центр → SFTP Server** (SFTP) - скачивание файла по расписанию
9. **SFTP Server → Monitoring** - логирование успешной передачи

**Характеристики:**
- Расписание: каждые 30 минут
- Формат файла: CSV/Excel (согласно требованиям партнера)
- Шифрование: AES-256
- Retention: хранение файлов 30 дней

#### Поток 3: Ввод ставок менеджерами (из Task 3)
1. **Менеджер депозитов** - загружает Excel или вводит вручную
2. **Rate Management UI → Rate Service** (REST/JSON) - создание/обновление ставок
3. **Rate Service → Rate DB** (ADO.NET) - сохранение ставок
4. **Rate Service → Redis Cache** (invalidate) - сброс кеша для актуальности данных

### Диаграммы C4

**Диаграмма контекста (Draw.io):** `context_diagram_rates_callcenter.drawio` - показывает систему в контексте акторов и внешних систем
**Диаграмма контейнеров (PlantUML):** `container_diagram_rates_callcenter.puml` - детализирует внутреннюю архитектуру с контейнерами и интеграциями

Диаграммы включают:
- Новые компоненты: Rate API, File Generator, Scheduler, SFTP Server
- Интеграции: REST API для кол-центра, SFTP для партнеров
- Хранилища: Rate DB, File Storage, Redis Cache
- Мониторинг всех компонентов

## Альтернативы

### Альтернатива 1: Прямое подключение к базе данных ставок

**Описание:** Кол-центр и партнеры напрямую подключаются к Rate DB через read-only доступ

**Преимущества:**
- Минимальная задержка данных (real-time)
- Простота технической реализации

**Недостатки:**
- Нарушение архитектурного принципа API-first
- Невозможность контроля нагрузки и rate limiting
- Сложность аудита доступа к данным
- Прямая зависимость от структуры БД (сложность изменений схемы)
- Нарушение безопасности (прямой доступ к БД)

**Решение:** Отклонена из-за архитектурных и security рисков

---

### Альтернатива 2: Интеграция через АБС

**Описание:** Передача ставок через существующую систему АБС вместо Rate Service

**Преимущества:**
- Использование существующих интеграций

**Недостатки:**
- Дополнительная нагрузка на уже перегруженную АБС (нарушение P2 из Task2)
- АБС не хранит ставки централизованно (ставки в Excel/Rate DB)
- Сложность синхронизации между Rate DB и АБС
- Зависимость от доработок legacy-системы на Delphi/PL-SQL
- Увеличение времени обновления ставок

**Решение:** Отклонена из-за нагрузки на АБС и архитектурных проблем

---

### Альтернатива 3: Email рассылка для партнеров

**Описание:** Отправка файлов со ставками партнерам по электронной почте

**Преимущества:**
- Простота реализации
- Не требуется SFTP инфраструктура

**Недостатки:**
- Низкий уровень безопасности (риск перехвата незашифрованных писем)
- Ручная обработка со стороны партнера
- Отсутствие автоматизации и мониторинга доставки
- Нарушение требований безопасности (+R7 из Task2: файловый обмен через SFTP)
- Сложность версионирования и отслеживания изменений

**Решение:** Отклонена из-за требований безопасности и автоматизации

---

### Альтернатива 4: Kafka для real-time обновлений кол-центра

**Описание:** Использование Kafka для push-уведомлений об изменении ставок вместо pull-запросов через API

**Преимущества:**
- Real-time обновления без опроса
- Снижение нагрузки от polling запросов
- Event-driven архитектура

**Недостатки:**
- Система кол-центра не поддерживает Kafka (proprietary CRM)
- Требуется разработка Kafka consumer в Integration Module
- Увеличение сложности для MVP (нарушение S3 из Task2: нет опыта с Kafka)
- Избыточность для данных, которые обновляются редко (раз в несколько часов)

**Решение:** Отложена на следующие итерации после MVP при необходимости масштабирования

## Недостатки, ограничения и риски

### Недостатки решения:
1. **Дублирование данных** - ставки хранятся в нескольких местах
2. **Задержка синхронизации** - партнерский кол-центр получает данные с задержкой
3. **Дополнительная сложность** - новые интеграционные точки

### Ограничения:
1. **Технические** - партнерский кол-центр работает только с файлами
2. **Форматные** - ограничения на форматы файлов (CSV/Excel)
3. **Сетевые** - зависимость от стабильности SFTP соединения

### Риски:
1. **Безопасность передачи** - риск перехвата файлов со ставками
2. **Доступность SFTP** - сбои могут прервать передачу данных
3. **Десинхронизация** - различные версии ставок в разных системах
4. **Производительность** - возможная нагрузка при множественных запросах

### Митигация рисков:

| Риск | Стратегия митигации | Метрики успеха |
|------|---------------------|----------------|
| Безопасность передачи | - AES-256 шифрование файлов<br>- SSH ключи для SFTP<br>- VPN туннель для партнеров<br>- Audit log всех операций | - 0 инцидентов перехвата<br>- 100% зашифрованных передач |
| Доступность SFTP | - Резервирование SFTP серверов (active-standby)<br>- Health checks каждые 60 сек<br>- Auto-failover при сбоях<br>- Alerting при недоступности | - SLA 99.9%<br>- Recovery time < 5 мин |
| Десинхронизация данных | - Версионирование файлов с timestamp<br>- Проверка MD5 checksum<br>- Мониторинг актуальности данных<br>- Автоматическая инвалидация кеша | - Разница версий < 15 мин<br>- 0 ошибок checksum |
| Производительность API | - Redis кеш с TTL 5 мин<br>- Rate limiting 100 req/min<br>- Горизонтальное масштабирование<br>- Connection pooling | - Response time < 500 мс<br>- 99.9% requests < 1 сек |
| Сбои генерации файлов | - Hangfire retry (3 попытки)<br>- Dead letter queue для ошибок<br>- Alerting при failures<br>- Manual trigger для recovery | - Success rate > 99%<br>- Mean time to recovery < 30 мин |

## Roadmap и план внедрения

### Фаза 1: Подготовка инфраструктуры (2 недели)

**Инфраструктурная команда:**
- Развертывание Redis Cache (staging и production)
- Настройка SFTP сервера с SSH ключами
- Конфигурация VPN туннелей для партнеров
- Настройка мониторинга (Prometheus/Grafana)

**DevOps команда:**
- Настройка CI/CD для Rate API и File Generator
- Конфигурация алертов для критических метрик
- Логирование и централизованный сбор логов (ELK stack)

### Фаза 2: Разработка компонентов (3 недели)

**Сервис управления ставками (.NET Core команда):**
- Разработка Rate API endpoints для кол-центра
  - GET /api/rates - получение всех ставок
  - GET /api/rates/{productId} - ставка по продукту
  - OAuth 2.0 middleware для аутентификации
- Интеграция Redis Cache с TTL 5 мин
- Rate limiting middleware (100 req/min)
- Реализация File Generator
  - CSV/Excel export
  - AES-256 encryption
  - MD5 checksum generation
- Настройка Hangfire Scheduler
  - Job: GenerateRatesFile (каждые 30 мин)
  - Retry policy (3 попытки)

### Фаза 3: Интеграция с системами (2 недели)

**Команда системы кол-центра:**
- Разработка Integration Module (REST Client)
- Модификация CRM UI для отображения ставок
- Тестирование интеграции с Rate API
- Обучение операторов новому функционалу

**Партнерский кол-центр:**
- Передача SSH ключей и настройка SFTP клиента
- Тестирование скачивания и расшифровки файлов
- Валидация формата CSV/Excel
- Обучение операторов партнера

### Фаза 4: Тестирование и запуск (1 неделя)

**Команда тестирования:**
- Функциональное тестирование API (UC1-UC6)
- Нагрузочное тестирование (JMeter: 1000 req/min)
- Тестирование SFTP передачи файлов
- Security тестирование (penetration tests)
- Проверка мониторинга и алертов

**Go-Live:**
- Пилотный запуск с 1 партнером
- Мониторинг метрик в реальном времени
- Постепенное подключение остальных партнеров

---

**Общее время реализации:** 8 недель
**Критический путь:** Инфраструктура → Разработка Rate API → Интеграция кол-центра → Go-Live
**Зависимости:** Task 3 (Rate Service должен быть развернут)

**Roadmap визуализация:**
- `RoadMap_банк_Стандарт_общий.drawio` - общий план по месяцам (Task 3: 6 недель, Task 4: 8 недель, Post-MVP: месяцы 5-12). Общее время MVP: 14 недель (3.5 месяца)
- `RoadMap_Task4_детальный.drawio` - детальный план Task 4 по неделям с разбивкой по фазам и системам (8 недель)

---

## Метрики успеха проекта

### Метрики производительности
- Response time Rate API: < 500 мс (99-й перцентиль)
- Время генерации файла: < 5 минут
- Cache hit rate: > 80%
- Uptime Rate API: > 99.9%

### Метрики бизнеса
- Количество консультаций через кол-центр: +30% за первый месяц
- Актуальность ставок для операторов: < 15 минут задержки
- Success rate передачи файлов партнерам: > 99%
- Время внедрения новых партнеров: < 2 дней

### Метрики безопасности
- Инциденты безопасности: 0
- Процент зашифрованных передач: 100%
- Неуспешные попытки аутентификации: отслеживание и блокировка
- Audit coverage: 100% всех операций

### Метрики качества кода
- Unit test coverage: > 80%
- Sonar quality gate: passed
- Critical vulnerabilities: 0
- Code review coverage: 100%