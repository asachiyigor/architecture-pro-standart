---
up:
  - "[[Task5]]"
---
# ADR: Заявка на кредит онлайн

**Автор:** Архитектор цифровой трансформации
**Дата:** 02.10.2025
**Статус:** Утверждено
**Версия:** 2.0
**Связано с:** Task 3 - ADR Открытие депозитов онлайн, Task 4 - ADR Передача ставок в кол-центр

## Задача

Спроектировать архитектуру для онлайн подачи заявок на кредит через сайт банка и интернет-банк. Решение должно обеспечить возможность получения предварительных решений для новых клиентов и обработку предодобренных кредитных предложений для существующих клиентов банка "Стандарт".

## Функциональные требования (Use Cases)

| ID | Use Case | Описание | Актор |
|----|----------|----------|-------|
| UC1 | Просмотр кредитных предложений на сайте | Новый клиент просматривает доступные кредитные продукты и базовые условия | Новый клиент |
| UC2 | Подача базовой заявки на кредит (ФИО + телефон) | Новый клиент подает упрощенную заявку, оставляя только контактные данные | Новый клиент |
| UC3 | Подача полной заявки с паспортными данными | Новый клиент заполняет полную заявку с паспортными данными для получения предварительного решения | Новый клиент |
| UC4 | Скоринг нового клиента | Система проводит скоринг через интеграцию с БКИ и выдает предварительное решение | Система скоринга |
| UC5 | СМС-уведомление о предварительном решении | Клиент получает СМС с информацией о результате предварительного скоринга | Новый клиент |
| UC6 | Просмотр персонализированных кредитных предложений | Существующий клиент видит предодобренные кредитные предложения в интернет-банке | Существующий клиент |
| UC7 | Подача заявки на предодобренный кредит | Клиент подает заявку на предодобренный кредит с указанием счета зачисления | Существующий клиент |
| UC8 | СМС-подтверждение заявки на кредит | Клиент подтверждает подачу заявки через СМС-код | Существующий клиент |
| UC9 | Упрощенный повторный скоринг | Система проводит упрощенный скоринг для существующих клиентов с предодобрением | Система скоринга |
| UC10 | Обработка заявки в отделении | Менеджер отделения работает с клиентом, пришедшим по предварительно одобренной заявке | Менеджер отделения |
| UC11 | Обработка заявки в кредитном конвейере | Сотрудник бэк-офиса обрабатывает заявку в кредитном конвейере с ускоренной процедурой | Менеджер кредитного бэк-офиса |
| UC12 | Уведомление о статусе заявки | Клиент получает СМС-уведомления об изменении статуса кредитной заявки | Клиент |

## Нефункциональные требования

### Производительность
- **U2, U3:** Время отклика интерфейсов < 1 сек для улучшения пользовательского опыта
- **Предварительное решение по скорингу:** < 2 минут (конкурентное преимущество)
- **Обработка предодобренных заявок:** в течение рабочего дня для лояльных клиентов
- **P1:** Система должна выдерживать увеличение нагрузки от маркетинговых кампаний
- **P2:** АБС не должна испытывать дополнительную нагрузку от онлайн-процессов
- **P3:** Поддержка горизонтального масштабирования микросервисов

### Надежность
- **R1:** Доступность 99.9%, 24/7 для банковских операций
- **R2:** Переключение между ЦОД при сбоях (существующая инфраструктура)
- **R3:** Резервное копирование данных заявок
- **R4:** Graceful обработка недоступности внешних сервисов (БКИ, скоринг)
- **Защита от перегрузки:** Rate limiting для системы скоринга

### Безопасность
- **+R1:** Шифрование данных при передаче (HTTPS/TLS для всех соединений)
- **+R3:** Изоляция данных депозитов и кредитов (требования безопасности банка)
- **F8:** СМС-подтверждение операций для аутентификации
- **Интеграция с БКИ:** по защищенным каналам (требования регулятора ЦБ РФ)
- **Паспортные данные:** шифрование AES-256 при хранении и передаче

### Совместимость и поддерживаемость
- **S1, S2:** Использование существующих технологий (MS SQL, Oracle, .NET)
- **S4:** Использование микросервисной архитектуры для новой функциональности
- **S5:** АБС остается системой записи (system of record)
- **+R4:** Невозможность модификации ядра интернет-банка (только API расширения)
- **Кредитный конвейер:** ограничение обмена данными - раз в сутки
- **Совместимость с системой дизайна:** единообразие интерфейсов

## Решение

### Концептуальная архитектура

Решение основано на создании нового кредитного микросервиса, который интегрируется с существующими системами банка и внешними сервисами. Архитектура обеспечивает быструю обработку предодобренных заявок и качественный скоринг новых клиентов.

### Ключевые архитектурные решения:

1. **Кредитный микросервис** - центральный компонент для управления кредитными заявками
2. **Асинхронная интеграция с кредитным конвейером** - через очереди для соблюдения ограничений обмена
3. **Прямая интеграция с системой скоринга** - для быстрого получения решений
4. **Кэширование предодобренных предложений** - для минимизации нагрузки на скоринг
5. **Расширение API Gateway** - для обслуживания кредитных запросов

### Основные компоненты:

#### 1. Credit Application Service (Кредитный сервис)
**Технологии:** .NET Core REST API, MS SQL, Entity Framework Core
**Ответственность:**
- Управление жизненным циклом кредитных заявок
- REST API для сайта и интернет-банка
- Валидация данных клиентов и заявок
- Интеграция с системой скоринга (синхронно)
- Управление статусами заявок
- Формирование данных для кредитного конвейера
- Мониторинг SLA обработки заявок

**База данных:** MS SQL (заявки, статусы, история изменений)

#### 2. Pre-Approved Offers Service (Сервис предодобренных предложений)
**Технологии:** .NET Core Background Service, MS SQL, Redis Cache
**Ответственность:**
- Периодический расчет предодобренных лимитов для существующих клиентов
- Персонализация кредитных условий на основе истории клиента
- Интеграция с системой скоринга для массового расчета (batch mode)
- Кэширование предложений (TTL 24 часа) для быстрого доступа
- API для получения предодобренных предложений

**База данных:** MS SQL (лимиты, условия, история расчетов)

#### 3. Credit Bureau Integration Service (Сервис интеграции с БКИ)
**Технологии:** .NET Core, MS SQL
**Ответственность:**
- Получение кредитных историй из БКИ по защищенным каналам
- Кэширование запросов к БКИ (снижение стоимости запросов)
- Мониторинг квот и лимитов запросов к БКИ
- Rate limiting для защиты от превышения квот
- Логирование всех запросов для аудита
- Retry механизм при сбоях БКИ

**База данных:** MS SQL (кеш кредитных историй, логи запросов)

#### 4. Message Queue (Очереди сообщений)
**Технологии:** Kafka (или альтернатива - см. раздел "Альтернативы")
**Ответственность:**
- Асинхронная передача заявок в кредитный конвейер (batch, раз в сутки)
- Уведомления о изменении статусов заявок
- Синхронизация данных с АБС (при необходимости)
- Dead Letter Queue для обработки ошибок

#### 5. Integration Adapter (Адаптер интеграции с кредитным конвейером)
**Технологии:** .NET Core, Hangfire
**Ответственность:**
- Формирование batch-файлов для кредитного конвейера
- Загрузка заявок в кредитный конвейер по расписанию (раз в сутки)
- Получение обновлений статусов из кредитного конвейера
- Мониторинг успешности передачи данных

#### 6. Redis Cache (Кэш)
**Технологии:** Redis
**Ответственность:**
- Кэширование предодобренных предложений (TTL 24 часа)
- Кэширование данных БКИ (TTL 7 дней, согласно регуляторным требованиям)
- Временное хранение результатов скоринга (TTL 1 час)
- Поддержка горизонтального масштабирования

### Интеграции и потоки данных:

#### Поток 1: Новый клиент подает полную заявку через сайт (с предварительным решением)
1. **Сайт → Credit Application Service** (REST/JSON) - отправка заявки с паспортными данными
2. **Credit Application Service → Credit DB** (ADO.NET) - сохранение заявки со статусом "На скоринге"
3. **Credit Application Service → Credit Bureau Service** (REST/JSON) - запрос кредитной истории
4. **Credit Bureau Service → БКИ** (HTTPS/XML, защищенный канал) - получение кредитной истории
5. **Credit Bureau Service → Redis Cache** (кеширование на 7 дней)
6. **Credit Application Service → Система скоринга** (SOAP/XML, синхронно) - расчет скорингового балла
7. **Credit Application Service → Credit DB** (обновление статуса: "Одобрено предварительно" / "Отклонено")
8. **Credit Application Service → СМС-шлюз** (REST/JSON) - уведомление клиента о решении
9. **Credit Application Service → Kafka** (async) - добавление в очередь для кредитного конвейера

**Характеристики:**
- Время обработки: < 2 минуты
- Предварительное решение в реальном времени
- Кеширование кредитной истории для повторных запросов

#### Поток 2: Существующий клиент подает заявку на предодобренный кредит через интернет-банк
1. **Интернет-банк → Pre-Approved Offers Service** (REST/JSON) - запрос предодобренных предложений
2. **Pre-Approved Offers Service → Redis Cache** (проверка кеша, TTL 24 часа)
3. **Pre-Approved Offers Service → Offers DB** (если кеш устарел) - чтение предложений
4. **Интернет-банк ← Pre-Approved Offers Service** (REST/JSON) - возврат персонализированных условий
5. **Интернет-банк → Credit Application Service** (REST/JSON) - подача заявки на предодобренный кредит
6. **Credit Application Service → Credit DB** (сохранение заявки со статусом "Предодобрено")
7. **Credit Application Service → Система скоринга** (упрощенная проверка, синхронно)
8. **Credit Application Service → СМС-шлюз** (запрос СМС-кода для подтверждения)
9. **Клиент → Интернет-банк → Credit Application Service** (подтверждение через СМС)
10. **Credit Application Service → Kafka** (async) - добавление в очередь для кредитного конвейера

**Характеристики:**
- Упрощенный скоринг для существующих клиентов
- СМС-подтверждение обязательно
- Быстрая обработка (< 1 минута)

#### Поток 3: Передача заявок в кредитный конвейер (batch, раз в сутки)
1. **Hangfire Scheduler** (01:00 ночи) - запуск задачи по расписанию
2. **Integration Adapter → Kafka** (consume) - чтение всех заявок за день
3. **Integration Adapter → Credit DB** (чтение полных данных заявок)
4. **Integration Adapter** - формирование batch-файла (XML/CSV)
5. **Integration Adapter → Кредитный конвейер** (File transfer или API) - передача файла
6. **Integration Adapter → Credit DB** (обновление статуса: "Передано в конвейер")
7. **Кредитный конвейер** - обработка заявок в течение дня
8. **Кредитный конвейер → Integration Adapter** (обратная связь) - статусы заявок
9. **Integration Adapter → Credit DB** (обновление финальных статусов)
10. **Credit Application Service → СМС-шлюз** (уведомления клиентов об изменении статуса)

**Характеристики:**
- Batch-обработка раз в сутки (ограничение кредитного конвейера)
- Асинхронная интеграция через Kafka
- Мониторинг успешности передачи данных

### Диаграммы C4

**Диаграмма контекста:** `context_diagram_credit_online.puml` 
**Диаграмма контейнеров:** `container_diagram_credit_online.puml`

## Альтернативы

### Альтернатива 1: Расширение депозитного сервиса

**Описание:** Добавление кредитной функциональности в существующий Deposit Service из Task 3

**Преимущества:**
- Единая база данных для всех продуктов
- Переиспользование инфраструктуры (Rate Service)
- Меньше микросервисов для поддержки

**Недостатки:**
- **Нарушение принципа единственной ответственности** (SRP)
- **Нарушение требования +R3:** изоляция кредитных и депозитных данных
- Смешивание различных бизнес-процессов (депозиты vs кредиты)
- Усложнение логики сервиса и увеличение рисков при изменениях
- Сложности масштабирования (разная нагрузка на кредиты и депозиты)
- Невозможность независимого развития продуктов

**Решение:** Отклонена из-за нарушения архитектурных принципов и бизнес-требований

---

### Альтернатива 2: Прямая интеграция с кредитным конвейером

**Описание:** Сайт и интернет-банк напрямую обращаются к кредитному конвейеру без промежуточного сервиса

**Преимущества:**
- Минимальное количество компонентов
- Прямой доступ к данным конвейера

**Недостатки:**
- **Ограничение обмена данными:** кредитный конвейер обновляется раз в сутки
- **Невозможность быстрой обработки заявок** (требование < 2 минут не выполнимо)
- Перегрузка кредитного конвейера онлайн-запросами
- Отсутствие кэширования и оптимизации запросов
- Нет возможности предоставить предварительное решение
- Нарушение требования P2 (защита критичных систем от нагрузки)

**Решение:** Отклонена из-за невыполнимости бизнес-требований по скорости обработки

---

### Альтернатива 3: Синхронная интеграция со всеми системами

**Описание:** Все интеграции (БКИ, скоринг, кредитный конвейер, АБС) выполняются синхронно в реальном времени

**Преимущества:**
- Всегда актуальные данные
- Нет задержек синхронизации

**Недостатки:**
- **Риск перегрузки критичных систем** (система скоринга, АБС)
- **Каскадные отказы:** сбой любой внешней системы блокирует всю цепочку
- **Нарушение ограничений:** кредитный конвейер не поддерживает real-time интеграцию
- Высокая связанность компонентов (tight coupling)
- Нарушение требования R4 (graceful degradation)
- Невозможность обработки пиковых нагрузок

**Решение:** Отклонена из-за рисков надежности и архитектурных ограничений

---

### Альтернатива 4: Использование RabbitMQ вместо Kafka

**Описание:** Использование RabbitMQ для асинхронной интеграции вместо Kafka

**Преимущества:**
- Проще в настройке и эксплуатации
- Команда имеет опыт работы с RabbitMQ
- Нет необходимости изучать Kafka (проблема S3 из Task2)

**Недостатки:**
- Меньшая пропускная способность по сравнению с Kafka
- Отсутствие persistence по умолчанию
- Сложнее масштабирование для высоких нагрузок

**Решение:** Может быть рассмотрена для MVP, если команда не готова к Kafka (см. требование S3). В этом случае RabbitMQ - приемлемая альтернатива для асинхронной интеграции с кредитным конвейером.

## Недостатки, ограничения и риски

### Недостатки решения:
1. **Дублирование данных** - кредитная информация хранится в нескольких местах
2. **Сложность синхронизации** - между кредитным сервисом и конвейером
3. **Зависимость от внешних систем** - БКИ, система скоринга
4. **Ограниченная пропускная способность** - лимиты запросов к БКИ

### Ограничения:
1. **Интеграционные** - кредитный конвейер обновляется раз в сутки
2. **Производительности** - система скоринга не должна перегружаться
3. **Регуляторные** - требования ЦБ по кредитным операциям
4. **Технологические** - совместимость с существующим стеком технологий

### Риски:
1. **Производительность скоринга** - риск перегрузки при высокой нагрузке
2. **Качество данных БКИ** - зависимость от внешнего провайдера
3. **Безопасность интеграций** - передача чувствительных данных
4. **Регуляторные изменения** - возможные изменения требований ЦБ
5. **Синхронизация систем** - риск рассинхронизации кредитных данных

### Митигация рисков:

| Риск | Стратегия митигации | Метрики успеха |
|------|---------------------|----------------|
| Производительность скоринга | - Rate limiting (max 100 req/min)<br>- Кэширование результатов (TTL 1 час)<br>- Batch processing предодобренных предложений<br>- Circuit breaker при перегрузке | - Response time < 2 мин (99%)<br>- Success rate > 99.5%<br>- Скоринг нагрузка < 80% capacity |
| Качество данных БКИ | - Кэширование (TTL 7 дней)<br>- Fallback на альтернативные источники<br>- Мониторинг качества данных<br>- Ручная эскалация при сбоях | - Data quality score > 95%<br>- БКИ availability > 99%<br>- Cache hit rate > 60% |
| Безопасность интеграций | - HTTPS/TLS для всех каналов<br>- OAuth 2.0 для API<br>- AES-256 для паспортных данных<br>- VPN туннели для БКИ<br>- Audit log всех операций | - 0 инцидентов безопасности<br>- 100% зашифрованных данных<br>- Audit coverage 100% |
| Регуляторные изменения | - Регулярный мониторинг ЦБ РФ<br>- Гибкая архитектура для изменений<br>- Compliance team review | - Compliance score 100%<br>- Time to adapt < 30 дней |
| Синхронизация систем | - Автоматическая сверка данных (ежедневно)<br>- Мониторинг расхождений<br>- Reconciliation отчеты<br>- Manual review при критичных расхождениях | - Data consistency > 99.9%<br>- Reconciliation time < 4 часа<br>- Critical issues = 0 |

## Roadmap и план внедрения

### Фаза 1: Инфраструктура и базовые сервисы (3 недели)

**Инфраструктурная команда:**
- Развертывание Redis Cache для кэширования
- Настройка Kafka (или RabbitMQ) для асинхронной интеграции
- Конфигурация VPN туннелей для БКИ
- Настройка мониторинга (Prometheus/Grafana)

**DevOps команда:**
- Настройка CI/CD для Credit Application Service
- Конфигурация алертов для критических метрик
- Логирование и централизованный сбор логов (ELK stack)

### Фаза 2: Разработка кредитных сервисов (4 недели)

**Команда Credit Application Service:**
- Разработка REST API endpoints
  - POST /api/credit/applications - создание заявки
  - GET /api/credit/applications/{id} - получение статуса
  - POST /api/credit/applications/{id}/confirm - СМС-подтверждение
- Интеграция с системой скоринга (SOAP)
- Управление статусами заявок
- Rate limiting middleware

**Команда Credit Bureau Service:**
- Разработка интеграции с БКИ
- Реализация кэширования (Redis, TTL 7 дней)
- Мониторинг квот БКИ
- Retry механизм и circuit breaker

**Команда Pre-Approved Offers Service:**
- Разработка batch-процессора для расчета лимитов
- API для получения предложений
- Интеграция с системой скоринга (batch mode)
- Hangfire scheduler для периодического расчета

### Фаза 3: Интеграция с системами (2 недели)

**Команда интеграции:**
- Integration Adapter для кредитного конвейера
- Формирование batch-файлов
- Hangfire scheduler для ежедневной передачи
- Обработка обратной связи от конвейера

**Команда фронтенда:**
- Модификация сайта для кредитных заявок
- Расширение интернет-банка (предодобренные предложения)
- Интеграция с Credit Application Service API
- UI для отображения статусов заявок

### Фаза 4: Тестирование и запуск (2 недели)

**Команда тестирования:**
- Функциональное тестирование API (UC1-UC12)
- Интеграционное тестирование с БКИ (test environment)
- Нагрузочное тестирование скоринга (JMeter)
- Security тестирование (OWASP Top 10)
- Проверка соответствия регуляторным требованиям

**Go-Live:**
- Пилотный запуск с ограниченной аудиторией (10% трафика)
- Мониторинг метрик в реальном времени
- Постепенное увеличение нагрузки (50%, 100%)

---

**Общее время реализации:** 11 недель
**Критический путь:** Инфраструктура → Credit Application Service → Интеграция с БКИ → Testing → Go-Live
**Зависимости:**
- Task 3 (опыт работы с микросервисами)
- Task 4 (опыт работы с асинхронными интеграциями)
- Доступ к БКИ (тестовая среда)
- Доступ к системе скоринга

## Метрики успеха проекта

### Метрики производительности
- Response time Credit API: < 1 сек (95-й перцентиль)
- Время принятия предварительного решения: < 2 минуты (99%)
- Cache hit rate (БКИ): > 60%
- Cache hit rate (предодобренные предложения): > 80%
- Uptime Credit Services: > 99.9%

### Метрики бизнеса
- Конверсия заявок (от просмотра до подачи): > 15%
- Конверсия предодобренных предложений: > 25%
- Время обработки заявки в конвейере: < 1 рабочий день
- Количество онлайн-заявок: +50% за первые 3 месяца
- NPS клиентов по онлайн-процессу: > 8.0

### Метрики безопасности
- Инциденты безопасности: 0
- Compliance нарушения (ЦБ РФ): 0
- Процент зашифрованных данных: 100%
- Audit coverage: 100%

### Метрики качества кода
- Unit test coverage: > 80%
- Sonar quality gate: passed
- Critical vulnerabilities: 0
- Code review coverage: 100%