---
up:
  - "[[Task3]]"
---
# ADR: Открытие депозитов онлайн (MVP)

**Автор:** Архитектор цифровой трансформации
**Дата:** 02.10.2025
**Статус:** Утверждено
**Версия:** 2.0

## Задача

Спроектировать архитектуру MVP для онлайн открытия депозитов в банке "Стандарт". Необходимо обеспечить возможность подачи заявок на депозиты через сайт (новые клиенты) и интернет-банк (существующие клиенты) с последующей обработкой заявок сотрудниками бэк-офиса.

## Функциональные требования (Use Cases)

| ID | Use Case | Описание | Актор |
|----|----------|----------|-------|
| UC1 | Просмотр ставок на сайте | Новый клиент просматривает актуальные ставки по депозитам на сайте | Новый клиент |
| UC2 | Подача заявки на депозит с сайта | Новый клиент подает заявку, указав ФИО и телефон | Новый клиент |
| UC3 | Обработка заявки от нового клиента | Менеджер кол-центра связывается с клиентом и предлагает условия | Менеджер кол-центра |
| UC4 | Просмотр персонализированных ставок в интернет-банке | Существующий клиент видит персональные ставки в интернет-банке | Существующий клиент |
| UC5 | Подача заявки на депозит в интернет-банке | Клиент подает заявку с указанием счета и суммы депозита | Существующий клиент |
| UC6 | СМС-подтверждение операции | Клиент подтверждает операцию через СМС-код | Существующий клиент |
| UC7 | Обработка заявки в бэк-офисе | Менеджер бэк-офиса обрабатывает заявку и корректирует ставку при необходимости | Менеджер бэк-офиса |
| UC8 | Уведомление о статусе заявки | Клиент получает СМС о подтверждении ставки и открытии депозита | Клиент |
| UC9 | Управление ставками | Менеджеры загружают и обновляют ставки по депозитам | Менеджеры депозитов/кредитов |

## Нефункциональные требования

### Производительность
- **U2, U3:** Время отклика интерфейсов < 1 сек для улучшения пользовательского опыта
- **P1:** Система должна выдерживать увеличение нагрузки от маркетинговых кампаний
- **P2:** АБС не должна испытывать дополнительную нагрузку от онлайн-процессов
- **P3:** Поддержка горизонтального масштабирования микросервисов

### Надежность
- **R1:** Доступность 99.9%, 24/7 для банковских операций
- **R2:** Переключение между ЦОД при сбоях (существующая инфраструктура)
- **R3:** Резервное копирование данных заявок
- **R4:** Graceful обработка недоступности внешних сервисов

### Безопасность
- **+R1:** Шифрование данных при передаче (HTTPS/TLS для всех соединений)
- **+R3:** Изоляция данных депозитов и кредитов (требования безопасности банка)
- **F8:** СМС-подтверждение операций для аутентификации

### Совместимость и поддерживаемость
- **S1, S2:** Использование существующих технологий (MS SQL, Oracle, .NET)
- **S5:** Микросервисная архитектура только для новых депозитных функций
- **U1:** Совместимость с системой дизайна для единообразия интерфейсов
- **+R4:** Нельзя модифицировать ядро интернет-банка подрядчика

## Решение

### Концептуальная архитектура

Решение основано на введении нового микросервиса "Депозитный сервис", который будет обрабатывать заявки на депозиты и интегрироваться с АБС через синхронные SOAP-вызовы для упрощения MVP.

### Ключевые архитектурные решения:

1. **Новый Депозитный микросервис** - центральный компонент для управления депозитными заявками
2. **Синхронная интеграция с АБС** - через SOAP/XML API для простоты MVP
3. **Отдельная БД для ставок** - централизованное хранение ставок с доступом для всех каналов
4. **REST API** - единый интерфейс для сайта и интернет-банка

### Основные компоненты:

#### 1. Депозитный сервис (Deposit Service)
**Технологии:** .NET Core, REST API, MS SQL
**Ответственность:**
- Прием и валидация заявок от сайта и интернет-банка
- Управление жизненным циклом заявок на депозиты
- Синхронная передача заявок в АБС через SOAP/XML
- Отправка СМС-уведомлений клиентам о принятии заявки
- Хранение истории заявок в собственной БД

#### 2. Сервис управления ставками (Rate Management Service)
**Технологии:** .NET Core, REST API, MS SQL, Oracle Client
**Ответственность:**
- Централизованное хранение актуальных ставок по депозитам
- Загрузка ставок из Excel-файлов (временное решение для MVP)
- Расчет персонализированных ставок на основе данных клиента из АБС
- Предоставление API для чтения ставок всем каналам (сайт, интернет-банк)
- Кеширование данных клиентов для снижения нагрузки на АБС

#### 3. Web Application (Интернет-банк)
**Технологии:** ASP.NET MVC 4.5, React.js
**Ответственность:**
- UI для существующих клиентов
- Отображение персонализированных ставок
- Форма подачи заявки на депозит
- СМС-подтверждение операций

#### 4. Сайт Банка
**Технологии:** PHP, React.js
**Ответственность:**
- Отображение информации о депозитах для потенциальных клиентов
- Прием заявок от новых клиентов (ФИО, телефон)
- Отображение базовых ставок

#### 5. АБС (Автоматизированная Банковская Система)
**Технологии:** Delphi (Desktop Client), PL-SQL (Oracle)
**Ответственность:**
- Обработка заявок менеджерами бэк-офиса
- Корректировка ставок при необходимости
- Открытие депозитных счетов
- Отправка СМС о статусе обработки
- Хранение мастер-данных клиентов

### Интеграции и потоки данных:

#### Поток 1: Новый клиент подает заявку через сайт
1. **Сайт → Rate Service** (REST/JSON) - получение актуальных ставок
2. **Сайт → Deposit Service** (REST/JSON) - отправка заявки (ФИО, телефон, продукт)
3. **Deposit Service → Deposit DB** (ADO.NET) - сохранение заявки
4. **Deposit Service → АБС** (SOAP/XML, синхронно) - передача заявки в очередь обработки
5. **Deposit Service → СМС-шлюз** (HTTP API) - уведомление о принятии заявки
6. **АБС Desktop Client** - менеджер обрабатывает заявку вручную
7. **АБС → СМС-шлюз** (HTTP API) - уведомление клиента о статусе

#### Поток 2: Существующий клиент подает заявку через интернет-банк
1. **Интернет-банк → Rate Service** (REST/JSON) - получение персонализированных ставок
   - **Rate Service → АБС DB** (Oracle Client, read-only) - чтение данных клиента для расчета ставки
2. **Интернет-банк → Deposit Service** (REST/JSON) - отправка заявки с СМС-подтверждением
3. **Deposit Service → Deposit DB** (ADO.NET) - сохранение заявки
4. **Deposit Service → АБС** (SOAP/XML, синхронно) - передача заявки
5. **Deposit Service → СМС-шлюз** (HTTP API) - уведомление о принятии
6. **АБС Desktop Client** - менеджер проверяет и подтверждает ставку
7. **АБС → АБС DB** (PL-SQL) - открытие депозитного счета
8. **АБС → СМС-шлюз** (HTTP API) - уведомление об открытии депозита

#### Поток 3: Управление ставками
1. **Менеджер** - загружает Excel-файл со ставками
2. **Rate Service** (File Import) - импорт ставок в Rate DB
3. **Rate Service → Rate DB** (ADO.NET) - сохранение актуальных ставок

### Диаграммы

**C4 Model (PlantUML):**
- **Context Diagram:** `context_diagram_deposits.puml` - показывает систему в контексте внешних акторов и систем
- **Container Diagram:** `container_diagram_deposits.puml` - детализирует внутреннюю структуру с контейнерами и интеграциями

## Альтернативы

### Альтернатива 1: Прямая интеграция сайта/интернет-банка с АБС

**Описание:** Интернет-банк и сайт напрямую обращаются к АБС без промежуточного Deposit Service

**Преимущества:**
- Минимальная сложность архитектуры
- Меньше компонентов для поддержки

**Недостатки:**
- Риск перегрузки АБС при маркетинговых кампаниях (нарушение P2)
- Отсутствие буферизации и throttling запросов к АБС
- Дублирование бизнес-логики между сайтом и интернет-банком
- Сложность добавления новых каналов продаж в будущем
- Отсутствие независимой истории заявок

**Решение:** Отклонена из-за рисков для стабильности АБС

---

### Альтернатива 2: Расширение функциональности интернет-банка

**Описание:** Добавление депозитной логики в существующий монолитный интернет-банк подрядчика

**Преимущества:**
- Использование существующей инфраструктуры
- Единая точка аутентификации

**Недостатки:**
- Нарушение ограничения +R4 (нельзя модифицировать ядро интернет-банка)
- Зависимость от подрядчика для любых изменений
- Монолитная архитектура усложняет независимое развитие
- Невозможность использовать для сайта (только для авторизованных клиентов)
- Нарушение S5 (микросервисы для новых функций)

**Решение:** Отклонена из-за контрактных ограничений и стратегии микросервисов

---

### Альтернатива 3: Асинхронная интеграция через Kafka

**Описание:** Использование Apache Kafka для асинхронной передачи заявок между Deposit Service и АБС

**Преимущества:**
- Полная развязка систем
- Защита АБС от пиковых нагрузок
- Возможность retry и гарантированная доставка
- Перспективная архитектура для будущего масштабирования

**Недостатки:**
- АБС на Delphi/PL-SQL не поддерживает Kafka напрямую - требуется Integration Service
- Увеличение сложности для MVP (дополнительный компонент)
- Команда не имеет опыта с Kafka (риск, нарушение S3)
- Асинхронность усложняет обработку ошибок и откат транзакций
- Задержка в обработке противоречит требованию P6 (реальное время для MVP)
- Дополнительные затраты на инфраструктуру и обучение

**Решение:** Отложена на следующие итерации после MVP. Рекомендуется рассмотреть при росте нагрузки или когда команда получит опыт с Kafka

## Недостатки, ограничения и риски

### Недостатки решения:
1. **Дополнительная сложность** - введение новых компонентов увеличивает сложность системы
2. **Синхронная связанность** - АБС должна быть доступна для приема заявок в реальном времени
3. **Дублирование данных** - ставки хранятся отдельно от АБС
4. **Нагрузка на АБС** - при большом потоке заявок может потребоваться оптимизация

### Ограничения:
1. **Технологические** - необходимо использовать совместимые с .NET технологии (S1, S2)
2. **Интеграционные** - АБС поддерживает только SOAP/XML интерфейсы
3. **Организационные** - нельзя модифицировать ядро интернет-банка подрядчика (+R4)

### Риски:
1. **Доступность АБС** - синхронная интеграция создает зависимость от доступности АБС
2. **Производительность АБС** - риск перегрузки при росте нагрузки (требует мониторинга P2)
3. **Безопасность** - новые точки входа требуют дополнительной защиты (+R1)
4. **Миграция процессов** - сложность перевода из Excel в новую систему (F13)

### Митигация рисков:
1. **Мониторинг производительности** АБС и времени отклика интеграций
2. **Throttling** - ограничение количества одновременных запросов к АБС
3. **Постепенное внедрение** начиная с MVP с малым объемом заявок
4. **Rollback план** - возможность вернуться к ручной обработке через АБС напрямую
5. **Кеширование** данных клиентов для персонализации ставок
